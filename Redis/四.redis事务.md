#### 四.redis事务

##### 1.redis事务

​	可以一次执行多个命令，本质是一组命令的集合，一个事务中的所有命令都会序列化，按顺序串行化执行而不会被其他命令插入，不许加塞

​	redis常用事务命令

![1566140786025](E:\Typora笔记\Pic\1566140786025.png)

![1566141117539](E:\Typora笔记\Pic\1566141117539.png)

![1566141336459](E:\Typora笔记\Pic\1566141336459.png)

![1566141915711](E:\Typora笔记\Pic\1566141915711.png)

![1566142034282](E:\Typora笔记\Pic\1566142034282.png)



​		Watch监控：

​				悲观锁	/	乐观锁	/	CAS（Check  And  Set）

​				悲观锁：每次拿数据的时候都认为被人会修改，所以每次在拿数据的时候都会上锁，这样别人想要拿到数据一定要等到锁解开才可以进行修改

​				乐观锁：每次拿数据认为别人不会修改数据，但是在更新的时候会判断在此期间别人有没有更新这个数据，可以使用版本号等机制，提交版本必须大于记录当前版本才能执行更新

​		![1566143272407](E:\Typora笔记\Pic\1566143272407.png)

![1566143476134](E:\Typora笔记\Pic\1566143476134.png)



​		当开启监控过程中，有加塞行为，数据已经被其他人动过

​				开启监控

![1566143591669](E:\Typora笔记\Pic\1566143591669.png)

​				将余额变为800

![1566143648948](E:\Typora笔记\Pic\1566143648948.png)

​				开启事务

![1566143695136](E:\Typora笔记\Pic\1566143695136.png)

​				此时余额为800

![1566143753076](E:\Typora笔记\Pic\1566143753076.png)

​		unwatch	：取消监控

![1566143987710](E:\Typora笔记\Pic\1566143987710.png)



​							**一旦执行了exec之前加的监控锁都会被取消**

小结：watch指令，类似于乐观锁，事务提交时，如果key的值已经被其他人改变，整个事物的的队列指令不会被执行，通过watch命令在事务执行之前监控了多个keys，倘若在watch指令之前监控了多个keys，倘若在watch之后任何key的值发生了变化，exec指令执行的事务，都将被放弃，同时返回Nullmulti-bulk应答已通知调用者事务执行失败

![1566144475358](E:\Typora笔记\Pic\1566144475358.png)



​						**部分存在事务，不保证原子性，如果一条出现了错误，其他的也会执行，不会回滚，没有原子性**

