#### 一.

![image-20200221201148539](%E6%9C%AA%E5%91%BD%E5%90%8D.assets/image-20200221201148539.png)

![image-20200221202409319](%E6%9C%AA%E5%91%BD%E5%90%8D.assets/image-20200221202409319.png)

![image-20200221202802452](%E6%9C%AA%E5%91%BD%E5%90%8D.assets/image-20200221202802452.png)

![image-20200221203050844](%E6%9C%AA%E5%91%BD%E5%90%8D.assets/image-20200221203050844.png)

![image-20200221203359456](%E6%9C%AA%E5%91%BD%E5%90%8D.assets/image-20200221203359456.png)

​	有很多的内存一致性协议

![image-20200221203707342](%E6%9C%AA%E5%91%BD%E5%90%8D.assets/image-20200221203707342.png)

![image-20200221204517103](%E6%9C%AA%E5%91%BD%E5%90%8D.assets/image-20200221204517103.png)

​	指令的重排序（乱序执行）

![image-20200221205006211](%E6%9C%AA%E5%91%BD%E5%90%8D.assets/image-20200221205006211.png)

​	问题:

​		DCL单例是不是要加volatile的问题

![image-20200221205518472](%E6%9C%AA%E5%91%BD%E5%90%8D.assets/image-20200221205518472.png)

​	（DCL写法单例模式）

![image-20200221210359787](%E6%9C%AA%E5%91%BD%E5%90%8D.assets/image-20200221210359787.png)

​	一定要加volatile关键字！

​	对象创建过程字节码：

![image-20200221210725369](%E6%9C%AA%E5%91%BD%E5%90%8D.assets/image-20200221210725369.png)

​	先申请一块内存，将m给默认值0，在调用构造器赋值为8，在建立堆栈之间的联系，即t=0，

​	如果一个线程new  #2执行完，另外的线程也来创建对象，但是发生了指令重排序，4和7调换了顺序，

​	volatile是怎么防止指令重排序：

![image-20200221211628614](%E6%9C%AA%E5%91%BD%E5%90%8D.assets/image-20200221211628614.png)

​	内存屏障：

![image-20200221211848883](%E6%9C%AA%E5%91%BD%E5%90%8D.assets/image-20200221211848883.png)

![image-20200221212006383](%E6%9C%AA%E5%91%BD%E5%90%8D.assets/image-20200221212006383.png)

![image-20200221212407991](%E6%9C%AA%E5%91%BD%E5%90%8D.assets/image-20200221212407991.png)

![image-20200221212512559](%E6%9C%AA%E5%91%BD%E5%90%8D.assets/image-20200221212512559.png)

​	内存屏障底层还是Lock指令（因为这条指令支持的CPU型号多）

![image-20200221212716975](%E6%9C%AA%E5%91%BD%E5%90%8D.assets/image-20200221212716975.png)

​	Hotspot









![image-20200221222005099](%E6%9C%AA%E5%91%BD%E5%90%8D.assets/image-20200221222005099.png)

![image-20200221222021850](%E6%9C%AA%E5%91%BD%E5%90%8D.assets/image-20200221222021850.png)

![image-20200221222049241](%E6%9C%AA%E5%91%BD%E5%90%8D.assets/image-20200221222049241.png)

![image-20200221222550472](%E6%9C%AA%E5%91%BD%E5%90%8D.assets/image-20200221222550472.png)

![image-20200221225345501](%E6%9C%AA%E5%91%BD%E5%90%8D.assets/image-20200221225345501.png)

